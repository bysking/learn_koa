<html>
<head>
  <title>数据持久化存储与获取（完成），新建一个store文件store.js（如果是网页，直接vuex和apisetPrefs相互替换即可）vuex是临时的数据共享，应</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="435"/>
<h1>数据持久化存储与获取（完成），新建一个store文件store.js（如果是网页，直接vuex和apisetPrefs相互替换即可）vuex是临时的数据共享，应</h1>

<div>
<span><div><div>数据持久化存储与获取（完成），新建一个store文件store.js（如果是网页，直接vuex和apisetPrefs相互替换即可）vuex是临时的数据共享，应用关闭后就消失了</div><hr/><ul><li><div>浏览器和手机的兼容</div></li></ul><div>指定标志： isBrowser:</div><div><br/></div><div>全局封装一个存储方法存数据兼容逻辑：定义setDate方法，内部代码如果是浏览器isBrowser，localStorage.setItem(key, data) 否则调用apicloud的存储方法（安卓和ios使用）</div><div><br/></div><div>如果存的数据是对象，需要进行序列化：</div><div><br/></div><div>if (typeof data === 'object') {</div><div>data = JSON.stringify(data)</div><div>}</div><div><br/></div><div><br/></div><div>api.setPrefs({</div><div>    key: key,</div><div>    value: data</div><div>})</div><div><br/></div><ul><li><div>问题一：我们怎么知道存放了什么数据呢：，需要对数据的key进行说明</div></li></ul><div>于是定义一个key的集合，限定范围，也方便我们查找：</div><div><br/></div><div>// 存储KEY</div><div>const Keys = {</div><div>    ACCESS_TOKEN: 'accessToken', // AccessToken</div><div>    USER_INFO: 'userInfo' // 用户数据</div><div>}</div><div><br/></div><div>在需要存放数据的js文件中，导入store模块，调用setDate方法即可，取数据getDate</div><div>类似的原理</div><div>store.setData(astore.Keys.ACCESS_TOKEN, res2.AccessToken)</div><div><br/></div><hr/><ul><li><div>然后是比如退出系统时数据的清除：</div></li></ul><div><br/></div><div>// 清除登录数据</div><div>function clearLoginData () {</div><div>//临时数据清空</div><div>datas = {}</div><div>//再清除缓存</div><div>//如果是浏览器</div><div>localStorage.removeItem(Keys.ACCESS_TOKEN)</div><div>localStorage.removeItem(Keys.USER_INFO)</div><div>//否则在安卓和ios上</div><div>api.removePrefs({ key: Keys.ACCESS_TOKEN })</div><div>api.removePrefs({ key: Keys.USER_INFO })</div><div><br/></div><div><br/></div><hr/><ul><li><div>数据存放后如何读取？</div></li></ul><div>/**</div><div>* 获取数据</div><div>* @param {String} key</div><div>*/</div><div>function getData (key) {</div><div>if (isBrowser) { // 判断运行环境</div><div>data = localStorage.getItem(key) // 浏览器直接从localStorage中拿</div><div>} else { // 手机，直接从文件拿</div><div>data = api.getPrefs({</div><div>sync: true,</div><div>key: key</div><div>})</div><div>}</div><div>try {</div><div>const storage = JSON.parse(data) // 存数据的时候序列化了，需要转化成对象</div><div>return storage</div><div>} catch (err) {</div><div>// console.log(err)</div><div>}</div><div>return data</div><div>}</div><hr/><div>示例：</div><div><br/></div><div>实例：</div><ul><li><div>用户退出逻辑，主要是把token清除，如果不存在token则不用做什么，否则需要进行判断如果是手机，就</div></li></ul><div>/**</div><div>* 退出</div><div>* @param {Number} delay 延迟时间</div><div>*/</div><div>export function logout (delay = 0) {</div><div>if (!astore.getAccessToken()) {</div><div>return</div><div>}</div><div><br/></div><div>if (!isBrowser) {</div><div>api.refreshHeaderLoadDone() // 手机端需要复位下拉刷新</div><div>}</div><div>astore.clearLoginData() // 清楚持久化的数据，上面定义的方法</div><div><br/></div><div>setTimeout(() =&gt; {// 退出判断，手机-浏览器两种环境</div><div>if (isBrowser) {</div><div>window.location.reload() // 浏览器-强制刷新当前页</div><div>} else {</div><div>api.rebootApp() // 手机-api.rebootApp()</div><div>}</div><div>}, delay)</div><div>}</div><ul><li><div>astore.clearLoginData() // 清楚持久化的数据 函数定义如下</div></li></ul><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(106, 153, 85); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">// 清除登录数据</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(86, 156, 214); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">function</span> <span style="color: rgb(220, 220, 170); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">clearLoginData</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">() {</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">datas</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">=</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">{}</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><br/></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(197, 134, 192); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">if</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">(</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">isBrowser</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">) {</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">localStorage</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(220, 220, 170); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">removeItem</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">(</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">Keys</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">ACCESS_TOKEN</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">)</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">localStorage</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(220, 220, 170); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">removeItem</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">(</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">Keys</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">USER_INFO</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">)</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">}</span> <span style="color: rgb(197, 134, 192); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">else</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">{</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">api</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(220, 220, 170); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">removePrefs</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">({</span> <span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">key:</span> <span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">Keys</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">ACCESS_TOKEN</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">})</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">api</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(220, 220, 170); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">removePrefs</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">({</span> <span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">key:</span> <span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">Keys</span><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">.</span><span style="color: rgb(156, 220, 254); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">USER_INFO</span> <span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">})</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(106, 153, 85); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">// api.removePrefs({ key: Keys.DDING_PERMISSION })</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(106, 153, 85); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">// api.removePrefs({ key: Keys.STORE })</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(106, 153, 85); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">// api.removePrefs({ key: Keys.PERMISSIONS })</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(106, 153, 85); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">// api.removePrefs({ key: Keys.NOTICE })</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">}</span></div><div style="background-color: rgb(30, 30, 30); font-size: 14px; white-space: pre;"><span style="color: rgb(212, 212, 212); font-family: Consolas, &quot;Courier New&quot;, monospace; font-size: 14px; line-height: 19px;">}</span></div><div><br/></div><ul><li><div>完整实例文件</div></li></ul><div><br/></div><div>import { isBrowser } from '@/libs/enum'</div><div><br/></div><div>// 存储KEY</div><div>const Keys = {</div><div>ACCESS_TOKEN: 'accessToken', // AccessToken</div><div>USER_INFO: 'userInfo' // 用户数据</div><div>}</div><div><br/></div><div>// 数据字典</div><div>let datas = {}</div><div><br/></div><div>// 初始化，从缓存中取出持久化数据</div><div>async function init () {</div><div>return await new Promise((resolve, reject) =&gt; {</div><div>setTimeout(() =&gt; {</div><div>for (const i in Keys) {</div><div>getData(Keys[i])</div><div>}</div><div>resolve()</div><div>}, 500)</div><div>})</div><div>}</div><div><br/></div><div>/**</div><div>* 设置数据</div><div>* @param {String} key</div><div>* @param {Object} data</div><div>*/</div><div>function setData (key, data) {</div><div>if (arguments.length !== 2) {</div><div>return</div><div>}</div><div><br/></div><div>if (typeof data === 'object') {</div><div>data = JSON.stringify(data)</div><div>}</div><div><br/></div><div>if (isBrowser) {</div><div>localStorage.setItem(key, data)</div><div>} else {</div><div>api.setPrefs({</div><div>key: key,</div><div>value: data</div><div>})</div><div>}</div><div><br/></div><div>datas[key] = data</div><div>}</div><div><br/></div><div>/**</div><div>* 获取数据</div><div>* @param {String} key</div><div>*/</div><div>function getData (key) {</div><div>let data = datas[key] || null</div><div><br/></div><div>if (isBrowser) {</div><div>data = localStorage.getItem(key)</div><div>} else {</div><div>data = api.getPrefs({</div><div>sync: true,</div><div>key: key</div><div>})</div><div>}</div><div><br/></div><div>try {</div><div>const storage = JSON.parse(data)</div><div>return storage</div><div>} catch (err) {</div><div>// console.log(err)</div><div>}</div><div><br/></div><div>return data</div><div>}</div><div><br/></div><div>// 获取AccessToken</div><div>function getAccessToken () {</div><div>return getData(Keys.ACCESS_TOKEN)</div><div>}</div><div><br/></div><div>// 获取用户信息</div><div>function getUserInfo () {</div><div>return getData(Keys.USER_INFO)</div><div>}</div><div><br/></div><div>// 清除登录数据</div><div>function clearLoginData () {</div><div>datas = {}</div><div><br/></div><div>if (isBrowser) {</div><div>localStorage.removeItem(Keys.ACCESS_TOKEN)</div><div>localStorage.removeItem(Keys.USER_INFO)</div><div>} else {</div><div>api.removePrefs({ key: Keys.ACCESS_TOKEN })</div><div>api.removePrefs({ key: Keys.USER_INFO })</div><div>// api.removePrefs({ key: Keys.DDING_PERMISSION })</div><div>// api.removePrefs({ key: Keys.STORE })</div><div>// api.removePrefs({ key: Keys.PERMISSIONS })</div><div>// api.removePrefs({ key: Keys.NOTICE })</div><div>}</div><div>}</div><div><br/></div><div>export default {</div><div>Keys,</div><div>init,</div><div>setData,</div><div>getAccessToken,</div><div>getUserInfo,</div><div>clearLoginData</div><div>}</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 